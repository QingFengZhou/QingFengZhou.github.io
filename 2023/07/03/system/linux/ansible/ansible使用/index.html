<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ansible使用 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="环境搭建 基于alpine 镜像搭建 安装步骤 参考资料   基于centos 7 镜像搭建 安装步骤   虚拟机多结点 virturebox网卡配置 虚拟机网络配置 参考资料     入门使用 配置文件 常用模块 shell 模块 script 模块   Playbook 执行shell 执行script   Become_user用法 用法 总体操作流程 参考文献        环境搭建">
<meta property="og:type" content="article">
<meta property="og:title" content="ansible使用">
<meta property="og:url" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="环境搭建 基于alpine 镜像搭建 安装步骤 参考资料   基于centos 7 镜像搭建 安装步骤   虚拟机多结点 virturebox网卡配置 虚拟机网络配置 参考资料     入门使用 配置文件 常用模块 shell 模块 script 模块   Playbook 执行shell 执行script   Become_user用法 用法 总体操作流程 参考文献        环境搭建">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.08.18.png">
<meta property="og:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.08.18.png">
<meta property="og:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.41.12.png">
<meta property="og:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.41.19.png">
<meta property="og:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.42.09.png">
<meta property="og:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.42.24.png">
<meta property="article:published_time" content="2023-07-03T15:58:16.000Z">
<meta property="article:modified_time" content="2023-07-04T01:22:20.854Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/%E6%88%AA%E5%B1%8F2023-07-04%2000.08.18.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://qingfengzhou.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-system/linux/ansible/ansible使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2023-07-03T15:58:16.000Z" itemprop="datePublished">2023-07-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/system-linux-ansible/">system/linux/ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      ansible使用
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <!-- toc -->

<ul>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">环境搭建</a><ul>
<li><a href="#%E5%9F%BA%E4%BA%8Ealpine-%E9%95%9C%E5%83%8F%E6%90%AD%E5%BB%BA">基于alpine 镜像搭建</a><ul>
<li><a href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4">安装步骤</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
</li>
<li><a href="#%E5%9F%BA%E4%BA%8Ecentos-7-%E9%95%9C%E5%83%8F%E6%90%AD%E5%BB%BA">基于centos 7 镜像搭建</a><ul>
<li><a href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4-1">安装步骤</a></li>
</ul>
</li>
<li><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%A4%9A%E7%BB%93%E7%82%B9">虚拟机多结点</a><ul>
<li><a href="#virturebox%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE">virturebox网卡配置</a></li>
<li><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">虚拟机网络配置</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-1">参考资料</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8">入门使用</a><ul>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">配置文件</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97">常用模块</a><ul>
<li><a href="#shell-%E6%A8%A1%E5%9D%97">shell 模块</a></li>
<li><a href="#script-%E6%A8%A1%E5%9D%97">script 模块</a></li>
</ul>
</li>
<li><a href="#playbook">Playbook</a><ul>
<li><a href="#%E6%89%A7%E8%A1%8Cshell">执行shell</a></li>
<li><a href="#%E6%89%A7%E8%A1%8Cscript">执行script</a></li>
</ul>
</li>
<li><a href="#become_user%E7%94%A8%E6%B3%95">Become_user用法</a><ul>
<li><a href="#%E7%94%A8%E6%B3%95">用法</a></li>
<li><a href="#%E6%80%BB%E4%BD%93%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B">总体操作流程</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

<h2><span id="环境搭建">环境搭建</span></h2><h3><span id="基于alpine-镜像搭建">基于alpine 镜像搭建</span></h3><p>alpine:3.17.3 版本，启动多个docker容器，模拟练习使用ansible</p>
<h4><span id="安装步骤">安装步骤</span></h4><p>1、按如下目录结构创建文件</p>
<img src="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/截屏2023-07-04 00.08.18.png">

<p>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">; 是否启用主机密钥检查: https://docs.ansible.com/ansible/latest/inventory_guide/connection_details.html#managing-host-key-checking</span><br><span class="line">; 初期使用密码连接分发公钥时先设置为False</span><br><span class="line">; 对应的环境变量设置: export ANSIBLE_HOST_KEY_CHECKING=False</span><br><span class="line">host_key_checking = False</span><br><span class="line">interpreter_python = /usr/bin/python</span><br></pre></td></tr></table></figure>

<p>&#x2F;etc&#x2F;ansible&#x2F;hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[myvirtualmachines]</span><br><span class="line">192.0.2.50</span><br><span class="line">192.0.2.51</span><br><span class="line">192.0.2.52</span><br></pre></td></tr></table></figure>

<p>Dockerfile:  构造生成 example-ansible-master 容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM example-ansible-node:latest</span><br><span class="line"></span><br><span class="line">RUN apk add --no-cache ansible openssh sshpass</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /etc/ansible &amp;&amp; \</span><br><span class="line">    ssh-keygen -t rsa -P &quot;&quot; -f ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>

<p>Dockerfile.node：生成 镜像example-ansible-node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:3.17.3</span><br><span class="line"></span><br><span class="line">RUN echo &quot;http://mirrors.aliyun.com/alpine/latest-stable/main/&quot; &gt; /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    echo &quot;http://mirrors.aliyun.com/alpine/latest-stable/community/&quot; &gt;&gt; /etc/apk/repositories</span><br><span class="line"></span><br><span class="line">RUN apk update &amp;&amp; \</span><br><span class="line">    apk add --no-cache openssh-server tzdata python3 &amp;&amp; \</span><br><span class="line">    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span><br><span class="line">    sed -i &quot;s/#PermitRootLogin.*/PermitRootLogin yes/g&quot; /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="line">    ssh-keygen -A &amp;&amp; \</span><br><span class="line">    echo &quot;root:123456&quot; | chpasswd</span><br><span class="line"></span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">CMD [&quot;/usr/sbin/sshd&quot;, &quot;-D&quot;]</span><br></pre></td></tr></table></figure>



<p>docker-compose.yml：启动四个容器：</p>
<p>example-ansible-master，example-ansible-node1，example-ansible-node2，example-ansible-node3</p>
<p>master安装ansible，运行ansible命令，控制操作其他三个结点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  net-ansible:</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 192.0.2.0/24</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  master:</span><br><span class="line">    build:</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">      context: .</span><br><span class="line">    container_name: example-ansible-master</span><br><span class="line">    hostname: ansible</span><br><span class="line">    volumes:</span><br><span class="line">      - ./etc/ansible:/etc/ansible</span><br><span class="line">      - ./ansible:/server/scripts/ansible</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.49</span><br><span class="line"></span><br><span class="line">  node1:</span><br><span class="line">    image: example-ansible-node</span><br><span class="line">    hostname: host1</span><br><span class="line">    container_name: example-ansible-node1</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.50</span><br><span class="line">  node2:</span><br><span class="line">    image: example-ansible-node</span><br><span class="line">    hostname: host2</span><br><span class="line">    container_name: example-ansible-node2</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.51</span><br><span class="line">  node3:</span><br><span class="line">    image: example-ansible-node</span><br><span class="line">    hostname: host3</span><br><span class="line">    container_name: example-ansible-node3</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.52</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、启动容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 构建host1、host2、host3的镜像</span><br><span class="line">docker build -t example-ansible-node -f ./Dockerfile.node .</span><br><span class="line"></span><br><span class="line"># 启动四个容器</span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、登录ansible容器，分发ssh公钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#进入ansible容器 (master)</span><br><span class="line">docker exec -it example-ansible-master ash</span><br><span class="line"></span><br><span class="line"># 执行下面命令分发ssh公钥</span><br><span class="line">ansible myvirtualmachines -k -m authorized_key -a &quot;user=root key=&#x27;&#123;&#123; lookup(&#x27;file&#x27;, &#x27;~/.ssh/id_rsa.pub&#x27;) &#125;&#125;&#x27;&quot;</span><br><span class="line">输入密码123456</span><br></pre></td></tr></table></figure>

<p>4、测试连通性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 测试连接</span><br><span class="line">ansible all -m ping</span><br><span class="line">ansible myvirtualmachines -m ping</span><br></pre></td></tr></table></figure>

<h4><span id="参考资料">参考资料</span></h4><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/624172594">用Docker搭建Ansible练习环境</a></p>
<p>如何使用容器模拟物理机学习使用ansible?<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/goloving/p/15032636.html">https://www.cnblogs.com/goloving/p/15032636.html</a><br><a target="_blank" rel="noopener" href="http://mactech.sheridanc.on.ca/team/mark-galaszkiewicz/getting-started-docker-ansible/">http://mactech.sheridanc.on.ca/team/mark-galaszkiewicz/getting-started-docker-ansible/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/shgh_2004/article/details/80599515">https://blog.csdn.net/shgh_2004/article/details/80599515</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1632980">https://cloud.tencent.com/developer/article/1632980</a></p>
<h3><span id="基于centos-7-镜像搭建">基于centos 7 镜像搭建</span></h3><p>Centos 7.9，启动多个docker容器，模拟练习使用ansible</p>
<p>&#x2F;Users&#x2F;****&#x2F;Desktop&#x2F;mydirect&#x2F;github&#x2F;ansible&#x2F;env_build2</p>
<h4><span id="安装步骤">安装步骤</span></h4><p>1、按如下目录结构创建文件</p>
<img src="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/截屏2023-07-04 00.08.18.png">

<p>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">; 是否启用主机密钥检查: https://docs.ansible.com/ansible/latest/inventory_guide/connection_details.html#managing-host-key-checking</span><br><span class="line">; 初期使用密码连接分发公钥时先设置为False</span><br><span class="line">; 对应的环境变量设置: export ANSIBLE_HOST_KEY_CHECKING=False</span><br><span class="line">host_key_checking = False</span><br><span class="line">interpreter_python = /usr/bin/python</span><br></pre></td></tr></table></figure>

<p>&#x2F;etc&#x2F;ansible&#x2F;hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[myvirtualmachines]</span><br><span class="line">192.0.2.50</span><br><span class="line">192.0.2.51</span><br><span class="line">192.0.2.52</span><br></pre></td></tr></table></figure>

<p>Dockerfile:  构造生成 example-ansible-cent-master 容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM example-ansible-cent-node:latest</span><br><span class="line"></span><br><span class="line">RUN yum install  -y ansible openssh sshpass</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /etc/ansible &amp;&amp; \</span><br><span class="line">    ssh-keygen -t rsa -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Dockerfile.node：生成 镜像example-ansible-cent-node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:centos7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RUN yum install -y openssh-server tzdata python3 &amp;&amp; \</span><br><span class="line">    cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span><br><span class="line">    sed -i &quot;s/#PermitRootLogin.*/PermitRootLogin yes/g&quot; /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="line">    ssh-keygen -A &amp;&amp; \</span><br><span class="line">    echo &quot;root:123456&quot; | chpasswd</span><br><span class="line"></span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">CMD [&quot;/usr/sbin/sshd&quot;, &quot;-D&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>docker-compose.yml：启动四个容器：</p>
<p>example-ansible-cent-master，example-ansible-cent-node1，</p>
<p>example-ansible-cent-node2，example-ansible-cent-node3</p>
<p>master安装ansible，运行ansible命令，控制操作其他三个结点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  net-ansible:</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 192.0.2.0/24</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  master:</span><br><span class="line">    build:</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">      context: .</span><br><span class="line">    container_name: example-ansible-cent-master</span><br><span class="line">    hostname: ansible</span><br><span class="line">    volumes:</span><br><span class="line">      - ./etc/ansible:/etc/ansible</span><br><span class="line">      - ./ansible:/server/scripts/ansible</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.49</span><br><span class="line"></span><br><span class="line">  node1:</span><br><span class="line">    image: example-ansible-cent-node</span><br><span class="line">    hostname: host1</span><br><span class="line">    container_name: example-ansible-cent-node1</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.50</span><br><span class="line">  node2:</span><br><span class="line">    image: example-ansible-cent-node</span><br><span class="line">    hostname: host2</span><br><span class="line">    container_name: example-ansible-cent-node2</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.51</span><br><span class="line">  node3:</span><br><span class="line">    image: example-ansible-cent-node</span><br><span class="line">    hostname: host3</span><br><span class="line">    container_name: example-ansible-cent-node3</span><br><span class="line">    networks:</span><br><span class="line">      net-ansible:</span><br><span class="line">        ipv4_address: 192.0.2.52</span><br></pre></td></tr></table></figure>

<p>2、启动容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 构建host1、host2、host3的镜像</span><br><span class="line">docker build -t example-ansible-cent-node -f ./Dockerfile.node .</span><br><span class="line"></span><br><span class="line"># 启动四个容器</span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、登录ansible容器，修改yum源，安装依赖，分发ssh公钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#进入ansible容器 (master)</span><br><span class="line">docker exec -it example-ansible-cent-master bash</span><br><span class="line"></span><br><span class="line">#安装依赖</span><br><span class="line">yum install -y net-tools openssh-clients wget</span><br><span class="line">#修改yum源</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum makecache</span><br><span class="line">#安装ansible和ssh</span><br><span class="line">yum install -y ansible openssh sshpass</span><br><span class="line"></span><br><span class="line"># 执行下面命令分发ssh公钥</span><br><span class="line">ansible myvirtualmachines -k -m authorized_key -a &quot;user=root key=&#x27;&#123;&#123; lookup(&#x27;file&#x27;, &#x27;~/.ssh/id_rsa.pub&#x27;) &#125;&#125;&#x27;&quot;</span><br><span class="line">输入密码123456</span><br></pre></td></tr></table></figure>

<p>4、测试连通性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 测试连接</span><br><span class="line">ansible all -m ping</span><br><span class="line">ansible myvirtualmachines -m ping</span><br></pre></td></tr></table></figure>

<p>5、所有结点关闭和启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose stop</span><br><span class="line">docker-compose start</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3><span id="虚拟机多结点">虚拟机多结点</span></h3><p>使用virturebox和centos7搭建多台虚拟机</p>
<p>网络配置需要配置两块网卡：其一保证可访问外网；其二分配固定ip，虚拟机之间互相访问</p>
<h4><span id="virturebox网卡配置">virturebox网卡配置</span></h4><img src="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/截屏2023-07-04 00.41.12.png">





<img src="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/截屏2023-07-04 00.41.19.png">



<img src="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/截屏2023-07-04 00.42.09.png">



<img src="/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/截屏2023-07-04 00.42.24.png">





<h4><span id="虚拟机网络配置">虚拟机网络配置</span></h4><p>cat  &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-enp0s3 (动态ip:dhcp)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TYPE=static</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=dhcp</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=enp0s3</span><br><span class="line">UUID=55fa0f47-7b70-40c7-a4c1-59e912cf5cc9</span><br><span class="line">DEVICE=enp0s3</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure>

<p>cat  &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-enp0s8 （静态：固定IP）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">TYPE=static</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=enp0s8</span><br><span class="line">#UUID=55fa0f47-7b70-40c7-a4c1-59e912cf5cc9</span><br><span class="line">DEVICE=enp0s8</span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IPADDR=192.168.56.101</span><br><span class="line">#NETMASK=255.255.255.0</span><br><span class="line">#GATEWAY=192.168.56.1</span><br></pre></td></tr></table></figure>

<h4><span id="参考资料">参考资料</span></h4><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/341328334">VirtualBox虚拟机配置双网卡同时连接内外网</a></p>
<h2><span id="入门使用">入门使用</span></h2><p>ansible是一个配置管理工具，通过ssh(或密码)管理多台主机，不是类似mysql的服务，底层基于python实现</p>
<h3><span id="配置文件">配置文件</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ansible主要文件：</span><br><span class="line"></span><br><span class="line">/etc/ansible/hosts 主机清单文件</span><br><span class="line">/etc/ansible/ansible.cfg 主配置文件</span><br><span class="line"></span><br><span class="line">ansible-doc -l 模块文档查看</span><br><span class="line">ansible-doc ping 模块用法</span><br><span class="line">ansible-doc -s ping  模块用法</span><br></pre></td></tr></table></figure>



<h3><span id="常用模块">常用模块</span></h3><h4><span id="shell-模块">shell 模块</span></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible myvirtualmachines -m shell -a &#x27;echo $HOSTNAME&#x27;</span><br></pre></td></tr></table></figure>

<h4><span id="script-模块">script 模块</span></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; /tmp/test1.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">echo  `date`</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ansible myvirtualmachines -m script -a /tmp/test1.sh</span><br></pre></td></tr></table></figure>



<h3><span id="playbook">Playbook</span></h3><p>cat &#x2F;etc&#x2F;ansible&#x2F;hosts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[myvirtualmachines]</span><br><span class="line">192.0.2.50</span><br><span class="line">192.0.2.51</span><br><span class="line">192.0.2.52</span><br><span class="line"></span><br><span class="line">[test1]</span><br><span class="line">host1 ansible_ssh_host=192.0.2.50 ansible_ssh_user=&quot;tom&quot; ansible_ssh_pass=&quot;tom&quot; ansible_ssh_port=22</span><br><span class="line">host2 ansible_ssh_host=192.0.2.51 ansible_ssh_user=&quot;tom&quot; ansible_ssh_pass=&quot;tom&quot; ansible_ssh_port=22</span><br><span class="line">host3 ansible_ssh_host=192.0.2.52 ansible_ssh_user=&quot;tom&quot; ansible_ssh_pass=&quot;tom&quot; ansible_ssh_port=22</span><br></pre></td></tr></table></figure>

<h4><span id="执行shell">执行shell</span></h4><p>ansible-playbook hello.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat hello.yml</span><br><span class="line"></span><br><span class="line">- hosts: test1</span><br><span class="line">  gather_facts: no</span><br><span class="line">  remote_user: tom</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: &#x27;echo 123\|&#x27;</span><br></pre></td></tr></table></figure>



<h4><span id="执行script">执行script</span></h4><p>ansible-playbook test1.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/test1.sh   </span><br><span class="line">#!/bin/bash</span><br><span class="line">echo 12333</span><br><span class="line"></span><br><span class="line">vi test1.yml</span><br><span class="line">- hosts: test1</span><br><span class="line">  gather_facts: no</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      script: /tmp/test1.sh    </span><br></pre></td></tr></table></figure>



<h3><span id="become_user用法">Become_user用法</span></h3><p>以非root用户执行playbook</p>
<h4><span id="用法">用法</span></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#命令行用法：适用于全局 (-u remote-user覆盖playbook定义的remote-user)</span><br><span class="line">ansible-playbook  -u tom -b --become-method sudo   hello2.yml </span><br><span class="line"></span><br><span class="line">cat hello2.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      script: /tmp/ansible/test1.sh</span><br><span class="line"></span><br><span class="line">cat test1.sh </span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; /etc/hosts</span><br><span class="line">#123</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#作用与play下的单个task</span><br><span class="line">ansible-playbook     hello4_2.yml </span><br><span class="line"></span><br><span class="line">cat hello4_2.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      script: /tmp/ansible/test1.sh</span><br><span class="line">      become_method: sudo</span><br><span class="line">      become: yes</span><br><span class="line">      </span><br><span class="line">cat test1.sh </span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; /etc/hosts</span><br><span class="line">#123</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#作用与单个play，应用到play下的每个task</span><br><span class="line">ansible-playbook     hello3.yml </span><br><span class="line"></span><br><span class="line">cat hello3.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  remote_user: tom</span><br><span class="line">  become_method: sudo</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: /usr/sbin/shutdown -h 23:50  </span><br><span class="line"></span><br><span class="line">#作用与单个play，应用到play下的每个task, 比hello3更精简</span><br><span class="line">cat hello4.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  become_method: sudo</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: /usr/sbin/shutdown -h 23:50  </span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">#作用与单个play，应用到play下的每个task, 比hello4 多了sudo</span><br><span class="line">cat hello5.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  become_method: sudo</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: sudo /usr/sbin/shutdown -h 23:50 </span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">总体来说，hello4最精简，不需要sudo, 不需要设置remote_user， hello4_2控制精度最高，become_user对应的是单个task</span><br><span class="line"></span><br><span class="line">become_method 默认值sudo，因此可以继续精简，如下是最简洁的写法 (hello3_3.yml)</span><br><span class="line">cat hello3_3.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: /usr/sbin/shutdown -h 23:50</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">其他用法：</span><br><span class="line">第一种：</span><br><span class="line">ansible-playbook -u tom hello4_3.yml </span><br><span class="line"></span><br><span class="line">cat hello4_3.yml </span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      script: /tmp/ansible/test1.sh</span><br><span class="line">      become_method: sudo</span><br><span class="line">      become: yes</span><br><span class="line"></span><br><span class="line">第二种：</span><br><span class="line">ansible-playbook hello3_2.yml </span><br><span class="line"></span><br><span class="line">cat hello3_2.yml </span><br><span class="line"> </span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  remote_user: tom</span><br><span class="line">  become_method: sudo</span><br><span class="line">  become_user: root</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: /usr/sbin/shutdown -h 23:50 </span><br><span class="line"></span><br><span class="line">第三种是错误的：如下所示</span><br><span class="line">####如下是错误的写法，要避免</span><br><span class="line">ansible-playbook -u tom hello4_4.yml</span><br><span class="line">ansible-playbook  hello4_4.yml</span><br><span class="line">- hosts: test2</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      script: /tmp/ansible/test1.sh</span><br><span class="line">      become_user: tom</span><br><span class="line">      become_method: sudo</span><br><span class="line">      become: yes</span><br></pre></td></tr></table></figure>



<h4><span id="总体操作流程">总体操作流程</span></h4><p>1、首先新建用户（比如tom），加入&#x2F;etc&#x2F;sudoers文件，确保新用户（tom）可以执行sudo su -</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#visudo 添加一行</span><br><span class="line">tom     ALL=(ALL)       ALL</span><br></pre></td></tr></table></figure>

<p>2、编辑 ansible的hosts文件信息，将服务器地址、用户等信息加入hosts文件中,</p>
<p>ansible_become_pass 等价于用户手动执行sudo command要输入的pwd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[test2]</span><br><span class="line">cent2 ansible_ssh_host=192.168.56.102 ansible_ssh_user=&quot;tom&quot; ansible_ssh_pass=&quot;tom&quot; ansible_ssh_port=22 ansible_become_pass=&quot;tom&quot;</span><br><span class="line">cent3 ansible_ssh_host=192.168.56.103 ansible_ssh_user=&quot;tom&quot; ansible_ssh_pass=&quot;tom&quot; ansible_ssh_port=22 ansible_become_pass=&quot;tom&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、修改 playbook yml文件，可以针对单个task， 单个play，或者所有play，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">--单个task</span><br><span class="line"></span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      script: /tmp/ansible/test1.sh</span><br><span class="line">      become_method: sudo</span><br><span class="line">      become: yes</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">--单个play</span><br><span class="line">- hosts: test2</span><br><span class="line">  gather_facts: no</span><br><span class="line">  become_method: sudo</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      shell: /usr/sbin/shutdown -h 23:50  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">--所有task</span><br><span class="line">ansible-playbook  -u tom -b --become-method sudo   hello2.yml </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4><span id="参考文献">参考文献</span></h4><p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15735145/5547297">play-book 普通用户提权</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_privilege_escalation.html">Understanding privilege escalation: become</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://qingfengzhou.github.io/2023/07/03/system/linux/ansible/ansible%E4%BD%BF%E7%94%A8/" data-id="cljn4kj610000rx9adxvgh8tg" data-title="ansible使用" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/07/04/system/linux/prometheus/prometheus%E4%BD%BF%E7%94%A8/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          prometheus使用
        
      </div>
    </a>
  
  
    <a href="/2023/07/03/tools/java/maven/maven%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">maven远程仓库配置</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ai-llm-langchain/">ai/llm/langchain</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ai-llm-prompt/">ai/llm/prompt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-flink-flink-doc/">bigdata/flink/flink_doc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-hadoop-hadoop-env/">bigdata/hadoop/hadoop_env</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-kafka/">bigdata/kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-nosql-hbase/">bigdata/nosql/hbase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-spark/">bigdata/spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-spark-spark3/">bigdata/spark/spark3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-spark-spark-env/">bigdata/spark/spark_env</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-spark-spark-tune/">bigdata/spark/spark_tune</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-spark-sparksql-kyuubi/">bigdata/spark/sparksql/kyuubi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata-sql/">bigdata/sql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-concurrent/">java/concurrent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-designpattern/">java/designpattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-jvm/">java/jvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life-daily/">life/daily</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life-fun/">life/fun</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/life-thought/">life/thought</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-linux-ansible/">system/linux/ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-linux-command/">system/linux/command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-linux-host-monitor/">system/linux/host/monitor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-linux-prometheus/">system/linux/prometheus</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-linux-vmware/">system/linux/vmware</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools-draw-%E5%9C%A8%E7%BA%BF%E7%94%BB%E5%9B%BE/">tools/draw/在线画图</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools-github-hexo/">tools/github/hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools-java-maven/">tools/java/maven</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/" rel="tag">flink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/health/" rel="tag">health</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/llm/" rel="tag">llm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/movie/" rel="tag">movie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/" rel="tag">spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/flink/" style="font-size: 10px;">flink</a> <a href="/tags/hadoop/" style="font-size: 10px;">hadoop</a> <a href="/tags/health/" style="font-size: 10px;">health</a> <a href="/tags/java/" style="font-size: 16.67px;">java</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/llm/" style="font-size: 13.33px;">llm</a> <a href="/tags/movie/" style="font-size: 10px;">movie</a> <a href="/tags/spark/" style="font-size: 20px;">spark</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/17/system/linux/vmware/vmware%E6%89%A9%E5%AE%B9/">vmware扩容</a>
          </li>
        
          <li>
            <a href="/2023/09/03/bigdata/flink/flink_doc/flink_shangguigu/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/08/21/life/english/">english</a>
          </li>
        
          <li>
            <a href="/2023/08/21/life/health/">health</a>
          </li>
        
          <li>
            <a href="/2023/08/21/life/culture/">culture</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>